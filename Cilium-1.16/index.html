<!doctype html><html lang=en><head><script async defer data-website-id=08a754c4-6690-46d7-bb80-8ff93cfa232f src=https://umami.oldwinter.top/umami.js></script><meta charset=utf-8><meta name=description content="更新范围包括  🚠 Networking 🕸️ Service Mesh & Ingress/Gateway API 💂‍♀️ Security 🌅 Day 2 Operations and Scale 🛰️ Hubble & Observability  Networking  🚤 Cilium NetKit: container-network throughput and latency as fast as host-network."><title>Cilium 1.16</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.ryken.cloud//icon.png><link href=https://www.ryken.cloud/styles.b3e1e36b0403ac565c9392b3e23ef3b6.min.css rel=stylesheet><link href=https://www.ryken.cloud/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.ryken.cloud/js/darkmode.66c3ed4615b59e04fa897375e67b0fe2.min.js></script>
<script src=https://www.ryken.cloud/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://www.ryken.cloud/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://www.ryken.cloud/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://www.ryken.cloud/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://www.ryken.cloud/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://www.ryken.cloud/",fetchData=Promise.all([fetch("https://www.ryken.cloud/indices/linkIndex.c83b530c16d6d7da0b36ea1cd7188b9b.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.ryken.cloud/indices/contentIndex.554015d53e2aa976650965a08f19d9ca.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://www.ryken.cloud",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.ryken.cloud",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-11MD77L81V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-11MD77L81V",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=search placeholder=支持标题及全文搜索...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.ryken.cloud/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://www.ryken.cloud/>Knowledge Garden</a></h1><div class=spacer></div><div id=search-icon><p>search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Cilium 1.16</h1><p class=meta>最近编辑于
Oct 29, 2024</p><ul class=tags></ul><aside class=mainTOC><details><summary>目录</summary><nav id=TableOfContents><ol><li><ol><li><a href=#更新范围包括>更新范围包括</a></li><li><a href=#networking>Networking</a></li><li><a href=#servicemesh--ingressgateway-api>ServiceMesh & Ingress/Gateway API</a></li><li><a href=#security>Security</a></li><li><a href=#day-2-operations-and-scale>Day 2 Operations and Scale</a></li><li><a href=#hubble--observability>Hubble & Observability</a></li><li><a href=#官方链接>官方链接</a></li></ol></li></ol></nav></details></aside><a href=#更新范围包括><h3 id=更新范围包括><span class=hanchor arialabel=Anchor># </span>更新范围包括</h3></a><ul><li>🚠 <em>Networking</em></li><li>🕸️ <em>Service Mesh & Ingress/Gateway API</em></li><li>💂‍♀️ <em>Security</em></li><li>🌅 <em>Day 2 Operations and Scale</em></li><li>🛰️ <em>Hubble & Observability</em></li></ul><a href=#networking><h3 id=networking><span class=hanchor arialabel=Anchor># </span>Networking</h3></a><ul><li>🚤 <em>Cilium NetKit:</em> container-network throughput and latency as fast as host-network.（吞吐、延迟赛比host，需要 kernel 6.7）</li><li>🌐 <em>BGPv2:</em> Fresh new API for Cilium&rsquo;s BGP feature.(cilium 1.10 之后支持 bgp)</li><li>📢 <em>BGP ClusterIP Advertisement:</em> BGP advertisements of ExternalIP and Cluster IP Services.</li><li>🔀 <em>Service Traffic Distribution:</em> Kubernetes 1.30 Service Traffic Distribution can be enabled directly in the Service spec instead of using annotations.</li><li>🔄 <em>Local Redirect Policy promoted to Stable:</em> Redirecting the traffic bound for services to the local backend, such as node-local DNS.(在 cilium 1.9中引入，通过将服务的流量边界定向到本地后端来防止流量甚至离开节点)</li><li>📡 <em>Multicast Datapath:</em> Define multicast groups in Cilium. - 需要使用 cilium-dbg CLI 定义多播组以及可能运行订阅者 Pod 的节点。</li><li>🏷️ <em>Per-Pod Fixed MAC Address:</em> Specify the MAC address used on a pod.</li><li><em>Node IPAM Service LB</em>: Ability to assign IP addresses from the nodes themselves to Kubernetes services, providing alternative access to services from outside of the cluster - 使用主机IP 作为 service externalip，并使用相应的主机端口，作为 LoadBalancer 访问入口。</li></ul><p>BGPv2
之前使用 CiliumBGPPeeringPolicy，有一些缺点，不够灵活；为了提供更高的灵活性，cilium 1.16 引入了新的 API - BGPv2
<img src=https://images.cherryfloris.eu.org/ryken/2024/08/b34690bd311420a9d591829c0af16cee.png width=auto alt=image.png></p><p>Service Traffic Distribution - 1.30 alpha / 1.31 beta</p><ul><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/#traffic-distribution rel=noopener>https://kubernetes.io/docs/concepts/services-networking/service/#traffic-distribution</a></li><li><a href=https://kubernetes.io/docs/reference/networking/virtual-ips/#traffic-distribution rel=noopener>https://kubernetes.io/docs/reference/networking/virtual-ips/#traffic-distribution</a>
trafficDistribution: PreferClose 如果区域中有端点，它们将接收该区域的所有流量，如果区域中没有端点，则流量将分发到其他区域.</li></ul><a href=#servicemesh--ingressgateway-api><h3 id=servicemesh--ingressgateway-api><span class=hanchor arialabel=Anchor># </span>ServiceMesh & Ingress/Gateway API</h3></a><ul><li>🧭 <em>Gateway API GAMMA Support:</em> East-west traffic management for the cluster via Gateway API.</li><li>⛩️ <em>Gateway API 1.1 Support:</em> Cilium now supports Gateway API 1.1. - 包括对 GAMMA和 GRPCRoute 的支持，增加了一些新的协议选项</li><li>🛂 <em>ExternalTrafficPolicy support for Ingress/Gateway API:</em> External traffic can now be routed to node-local or cluster-wide endpoints. - 确保保留客户端IP</li><li>🕸️ <em>L7 Envoy Proxy as dedicated DaemonSet:</em> With a dedicated DaemonSet, Envoy and Cilium can have a separate life-cycle from each other. Now on by default for new installs.</li><li>🗂️ <em>NodeSelector support for CiliumEnvoyConfig:</em> Instead of being applied on all nodes, it&rsquo;s now possible to select which nodes a particular CiliumEnvoyConfig should select.</li></ul><p>Gateway API GAMMA Support
GAMMA 是 Gateway API for Mesh Management and Administration 的简称，为集群的东西向流量管理提供一致的模型，例如集群内部基于路径的路由和负载平衡</p><a href=#security><h3 id=security><span class=hanchor arialabel=Anchor># </span>Security</h3></a><ul><li>📶 <em>Port Range support in Network Policies:</em> This long-awaited feature has been implemented into Cilium.（网络策略的端口范围的支持 k8s 1.21-1.25 stable）</li><li>📋 <em>Network Policy Validation Status:</em> kubectl describe cnp will be able to tell if the Cilium Network Policy is valid or invalid.(增加 status 字段，可以通过 describe 查看 networkpolicy 的验证是否通过)</li><li>⛔ <em>Control Cilium Network Policy Default Deny behavior:</em> Policies usually enable default deny for the subject of the policies, but this can now be disabled on a per-policy basis.（增加网络策略默认不做处理，需要指定为 true 才执行策略，允许平台所有者安全地推出新的网络策略，而不会产生中断现有流量的风险。）</li><li>👥 <em>CIDRGroups support for Egress and Deny rules:</em> Add support for matching CiliumCIDRGroups in Egress policy rules.</li><li>💾 <em>Load &ldquo;default&rdquo; Network Policies from Filesystem:</em> In addition to reading policies from Kubernetes, Cilium can be configured to read policies locally.（类似 static pod，但是使用 kubectl get cnp 查询不到，需要使用 cilium-dbg policy 查看）</li><li>🗂️ <em>Support to Select Nodes as Target of Cilium Network Policies:</em> With new ToNodes/FromNodes selectors, traffic can be allowed or denied based on the labels of the target Node in the cluster.（功能增强，之前只能使用 remote-nodeentity 或者 CIDR-based 的策略，但是有一定的缺陷，现在可以使用 node label 进行选择）</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>cilium.io/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CiliumClusterwideNetworkPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>xxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enableDefaultDeny</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>egress</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ingress</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#day-2-operations-and-scale><h3 id=day-2-operations-and-scale><span class=hanchor arialabel=Anchor># </span>Day 2 Operations and Scale</h3></a><ul><li>🧝 <em>New ELF Loader Logic:</em> With this new loader logic, the median memory usage of Cilium was decreased by 24%.</li><li>🚀 <em>Improved DNS-based network policy performance:</em> DNS-based network policies had up to 5x reduction in tail latency.</li><li>🕸️ <em>KVStoreMesh default option for ClusterMesh:</em> Introduced in Cilium 1.14, and after a lot of adoption and feedback from the community, KVStoreMesh is now the default way to deploy ClusterMesh.</li></ul><p>ELF Loader Logic
理论上，只要端点的配置发生变化，我们就必须重新编译端点的 BPF。编译是一个相当昂贵的过程，因此开发了一种名为“ELF 模板/替换”的机制来避免在最常见的情况下重新编译。然而，这个替代过程并不是最理想的。在 Cilium 1.16 中，它得到了改进，导致显着的内存增益</p><p>DNS-based network policy
Cilium 网络策略如此受集群管理员欢迎的原因之一是:它们能够根据完全限定域名 (FQDN) 进行过滤。  DNS 感知的 Cilium 网络策略使用户能够根据特定 FQDN 允许流量。</p><a href=#hubble--observability><h3 id=hubble--observability><span class=hanchor arialabel=Anchor># </span>Hubble & Observability</h3></a><ul><li>🗣️ <em>CEL Filters Support:</em> Hubble supports Common Express Language (CEL) giving support for more complex conditions that cannot be expressed using the existing flow filters.（通用表达式语言 (CEL) 是表达式求值通用语义的实现。它旨在快速、便携且安全地执行性能关键型应用程序。将 CEL 引入 Hubble 的动机是支持目前无法使用现有流量过滤器表达的更复杂的条件。目前，Hubble CLI 中的 Hubble observe 对所有参数使用一个 AND 过滤器。引入 CEL 后可以使用 –cel-expression 过滤）</li><li>📊 <em>Improved HTTP metrics:</em> There are additional metrics to count the HTTP requests and their duration.</li><li>📏 <em>Improved BPF map pressure metrics:</em> New metric to track the BPF map pressure metric for the Connection Tracking BPF map.</li><li>👀 <em>Improvements for Egress Traffic Path Observability:</em> Some metrics were added on this release to help troubleshooting Cilium Egress Routing.</li><li>🔬 <em>K8S Event Generation on Packet Drop:</em> Hubble is now able to generate a k8s event for a packet dropped from a pod and it that can be verified with kubectl get events.数据包因为网络策略丢弃时，会在相应 pod 上生成事件 - alpha 版本</li><li>🗂️ <em>Filtering Hubble flows by node labels:</em> Filter Hubble flows observed on nodes matching the given label. - hubble observe 命令</li></ul><a href=#官方链接><h3 id=官方链接><span class=hanchor arialabel=Anchor># </span>官方链接</h3></a><ul><li>gateway api 介绍：
<a href=https://gateway-api.sigs.k8s.io/ rel=noopener>https://gateway-api.sigs.k8s.io/</a></li><li><a href=https://isovalent.com/blog/post/cilium-1-16/ rel=noopener>https://isovalent.com/blog/post/cilium-1-16/</a></li><li><a href=https://github.com/cilium/cilium/releases/tag/v1.16.0 rel=noopener>https://github.com/cilium/cilium/releases/tag/v1.16.0</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>反向链接</h3><ul class=backlinks><li>未发现反向链接</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>内部链接关系图</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.ryken.cloud/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><hr><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><script src=alittlejs/md5.min.js></script><div id=gitalk-container></div><script>var gitalk=new Gitalk({clientID:"d21f4afcd185c95004e0",clientSecret:"8f1f442abf93a76461783af21c544717da9fc7b3",repo:"obsidian-publish",owner:"renyunkang",admin:["renyunkang"],id:location.href,distractionFreeMode:!1});gitalk.render("gitalk-container")</script><center><script>var caution=!1,now,visits;function setCookie(e,t,n,s,o,a){var i=e+"="+escape(t)+(n?"; expires="+n.toGMTString():"")+(s?"; path="+s:"")+(o?"; domain="+o:"")+(a?"; secure":"");!caution||(e+"="+escape(t)).length<=4e3?document.cookie=i:confirm("Cookie exceeds 4KB and will be cut!")&&(document.cookie=i)}function getCookie(s){var e=s+"=",n,t=document.cookie.indexOf(e);return t==-1?null:(n=document.cookie.indexOf(";",t+e.length),n==-1&&(n=document.cookie.length),unescape(document.cookie.substring(t+e.length,n)))}function deleteCookie(e,t,n){getCookie(e)&&(document.cookie=e+"="+(t?"; path="+t:"")+(n?"; domain="+n:"")+"; expires=Thu, 01-Jan-70 00:00:01 GMT")}function fixDate(e){var n=new Date(0),t=n.getTime();t>0&&e.setTime(e.getTime()-t)}now=new Date,fixDate(now),now.setTime(now.getTime()+730*24*60*60*1e3),visits=getCookie("counter"),visits?visits=parseInt(visits)+1:visits=1,setCookie("counter",visits,now),document.write("<font size=2>👋访问量："+visits+"")</script></center></div></body></html>