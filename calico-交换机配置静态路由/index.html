<!doctype html><html lang=en><head><script async defer data-website-id=08a754c4-6690-46d7-bb80-8ff93cfa232f src=https://umami.oldwinter.top/umami.js></script><meta charset=utf-8><meta name=description content="背景 在一些客户部署 kse 时，明确要求 pod id 可路由到，换言之需要使用 underlay 网络，与底层网络打通。现有的一些 underlay 网络方案可以选用基于 vlan 的技术实现也可以选用基于 bgp 的技术实现。两种技术实现均需要交换机侧做一些额外配置来符合网络需求：
 bgp 技术实现需要：配置交换机 bgp 连接 或者 配置静态路由； vlan 技术实现需要：配置 trunk 模式、配置 vlan 网关  kse 中默认交付的是 calico，所以我们就 calico bgp 展开讨论："><title>calico 交换机配置静态路由</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.ryken.cloud//icon.png><link href=https://www.ryken.cloud/styles.b3e1e36b0403ac565c9392b3e23ef3b6.min.css rel=stylesheet><link href=https://www.ryken.cloud/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.ryken.cloud/js/darkmode.66c3ed4615b59e04fa897375e67b0fe2.min.js></script>
<script src=https://www.ryken.cloud/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://www.ryken.cloud/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://www.ryken.cloud/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://www.ryken.cloud/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://www.ryken.cloud/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://www.ryken.cloud/",fetchData=Promise.all([fetch("https://www.ryken.cloud/indices/linkIndex.c83b530c16d6d7da0b36ea1cd7188b9b.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.ryken.cloud/indices/contentIndex.a478ecebe83dde54b122be54cf4eea57.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://www.ryken.cloud",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.ryken.cloud",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-11MD77L81V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-11MD77L81V",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=search placeholder=支持标题及全文搜索...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.ryken.cloud/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://www.ryken.cloud/>Knowledge Garden</a></h1><div class=spacer></div><div id=search-icon><p>search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>calico 交换机配置静态路由</h1><p class=meta>最近编辑于
Dec 16, 2024</p><ul class=tags></ul><aside class=mainTOC><details><summary>目录</summary><nav id=TableOfContents><ol><li><ol><li><a href=#背景>背景</a></li><li><a href=#calico-bgp-交付方案>calico bgp 交付方案</a></li><li><a href=#探讨静态路由的方案>探讨静态路由的方案</a></li></ol></li></ol></nav></details></aside><a href=#背景><h3 id=背景><span class=hanchor arialabel=Anchor># </span>背景</h3></a><p>在一些客户部署 kse 时，明确要求 pod id 可路由到，换言之需要使用 underlay 网络，与底层网络打通。现有的一些 underlay 网络方案可以选用基于 vlan 的技术实现也可以选用基于 bgp 的技术实现。两种技术实现均需要交换机侧做一些额外配置来符合网络需求：</p><ul><li>bgp 技术实现需要：配置交换机 bgp 连接 或者 配置静态路由；</li><li>vlan 技术实现需要：配置 trunk 模式、配置 vlan 网关</li></ul><p>kse 中默认交付的是 calico，所以我们就 calico bgp 展开讨论：</p><a href=#calico-bgp-交付方案><h3 id=calico-bgp-交付方案><span class=hanchor arialabel=Anchor># </span>calico bgp 交付方案</h3></a><p>calico 交付 bgp 方案有以下三种：</p><ul><li>FULL-MESH + bgp peer</li><li>TOR 路由反射器</li><li>RR in cluster 路由反射器 + bgp peer
<img src=https://images.cherryfloris.eu.org/ryken/2023/12/d5f6aa319080943102022b88a3297fa1.png width=auto alt=image.png></li></ul><p><strong>FullMesh</strong></p><ul><li>集群内默认的连接方式。集群内节点两两建立 bgp 连接来交换路由信息。</li></ul><p>不向外部暴露 pod ip：</p><ul><li>创建的 ippool 可以为 overlay 模式(ipip、vxlan)</li><li>创建的 ippool 可以为 bgp 模式(ipipmode=Never、vxlanMode=Never 需要节点在同一个网络域中；创建路由的下一跳为节点的 ip，跨网络域会导致网络不通)</li></ul><p>向外部暴露 pod ip：</p><ul><li>需要额外配置 bgp peer (交换机/路由器)，将每个节点的路由信息宣告给 peer。</li></ul><p><strong>TOR</strong></p><ul><li>禁用 fullmesh，集群内的所有节点与所 tor 路由器建立 bgppeer，向外部宣告路由</li><li>创建的 ippool 为 BGP 模式(ipipmode=Never、vxlanMode=Never)</li><li>配置为 tor 表示默认向外部暴露 pod ip</li></ul><p><strong>RR in cluster</strong></p><ul><li>禁用 fullmesh，选取集群内的一个或者多个节点为 rr server 节点，集群内的其他节点作为 rr client与该节点建立 ibgp 连接。</li></ul><p>不向外部暴露 pod ip：</p><ul><li>创建的 ippool 可以为 overlay 模式(ipip、vxlan)</li><li>创建的 ippool 可以为 bgp 模式(ipipmode=Never、vxlanMode=Never 需要节点在同一个网络域中；创建路由的下一跳为节点的 ip，跨网络域会导致网络不通)</li></ul><p>向外部暴露 pod ip：</p><ul><li>rr server 节点同外部交换机建立 bgp peer，向外部宣告路由</li></ul><blockquote><p>ps: fullmesh 非常适合 100 个或更少节点的中小型部署，但在规模明显更大时，fullmesh的效率会降低，建议使用路由反射器(Route reflectors)。</p></blockquote><a href=#探讨静态路由的方案><h3 id=探讨静态路由的方案><span class=hanchor arialabel=Anchor># </span>探讨静态路由的方案</h3></a><p>客户需求如下：</p><ul><li>业务 ippool 与集群基础架构的 ippool 分离</li><li>业务 ippool 在调度过程中只使用业务 ippool</li><li>业务 ippool 需要可路由</li><li>交换机侧不愿配置 bgp</li></ul><p><img src=https://images.cherryfloris.eu.org/ryken/2024/01/1dbb384ce7b5bea688b93ef7fab882f4.png width=auto alt=270f184fcaa92acbbc9452e2d271232.png></p><a href=#简单要求简单方案><h4 id=简单要求简单方案><span class=hanchor arialabel=Anchor># </span>简单要求，简单方案</h4></a><p>要求：</p><ul><li>集群节点在同一个网段，ippool 不启用 overlay 网络</li><li>ippool 不绑定节点，可与 namespace 绑定</li><li>允许借用 ip</li><li>业务 ippool 与平台 ippool 分开使用</li></ul><blockquote><p>【说明1】：
对于某一个 namespace 如果没有给其分配 ippool，对于则该 namespace 下负载应该如果处理有以下两个方案：</p><ol><li>使用平台默认的 ippool 创建</li><li>该 namespace 下的负载无法创建成功</li></ol><p>建议使用第一种方式解决，因为无法判断某一个 namespace 为客户创建还是 kse 插件或者某一个 kse 内部组件自己创建的，若使用第二种方式，维护成本比较高。
<strong>以下方案是基于第一种处理方法展开</strong>。</p><p>【说明2】：
需要判断 ippool 与节点的绑定是否为强需求。图中的客户需求规划将 ippool 与节点做了绑定，但是在实际的情况中，外部只需感知整个 podcidr 发往集群节点，无需感知具体哪一个子段发往哪一个节点。
客户给出的规划：
<img src=https://images.cherryfloris.eu.org/ryken/2024/12/d9c443c9cb6b0c1a971e0c798488471b.png width=auto alt=image.png>
简单需求的理想规划：
<img src=https://images.cherryfloris.eu.org/ryken/2024/12/50bb94981e6d896722a6c009f302b117.png width=auto alt=image.png>
当有与 namespace 的绑定的需求时，可以再进行细化，进而拆分成更细小的 ippool
若为强需求则考虑后续方案。若不是强需求，考虑以下方案：</p></blockquote><p>方案：</p><ul><li>安装集群时禁用默认 ippool</li><li>创建平台使用的 ippool 以及业务使用的 ippool，并将业务的 ippool 的 nodeSelector 设置为 ’!all()‘，表示只允许指定分配，无法自动分配。</li><li>用户创建相应的 namespace 时，绑定相应的 ippool</li><li>在交换机侧设置静态路由 set protocols static route ${podcidr} nexthop ${集群节点 ip}</li></ul><blockquote><p>在安装集群时禁用了默认 ippool，避免配置的 podCIDR 初始化为一个 ippool 使得其使用率不高，禁用之后，用户可以根据自己的实际规划来创建合适大小的 ippool 用于平台 pod 和 业务 pod。</p></blockquote><p>静态路由可以设置一条，也可以设置多条并启用 ecmp，<code>${集群节点 ip}</code> 选用某一个集群节点即可。假设<code>${集群节点 ip}</code>选用 master 节点，此时的到达 podCIDR 的流量都会经由 master 节点做转发。</p><a href=#配置补充说明><h5 id=配置补充说明><span class=hanchor arialabel=Anchor># </span>配置补充说明：</h5></a><p>了解下 calico 的 ipam 分配的过程：</p><p>ippool 是 calico 用于 ipam 分配的总的 ip 池。当使用 kk 安装集群时，calico 会默认将配置的 podCIDR 初始化为自己的一个默认的 default-ipv4-ippool，当然这个默认的 ippool 也是可以通过配置禁用掉，进而用户自行创建自定义的 ippool</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubekey.kubesphere.io/v1alpha2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sample</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>plugin</span><span class=p>:</span><span class=w> </span><span class=l>calico</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    calico:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      defaultIPPOOL: false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubePodsCIDR</span><span class=p>:</span><span class=w> </span><span class=m>10.233.64.0</span><span class=l>/18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubeServiceCIDR</span><span class=p>:</span><span class=w> </span><span class=m>10.233.0.0</span><span class=l>/18</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>crd.projectcalico.org/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IPPool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-ipv4-ippool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allowedUses</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>Workload</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>Tunnel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>blockSize</span><span class=p>:</span><span class=w> </span><span class=m>26</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.233.64.0</span><span class=l>/18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipipMode</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>natOutgoing</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w> </span><span class=l>all()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vxlanMode</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ippool 有一个 blocksize 字段，用于将整个大段的 ippool cidr 分为更细小的 block 块，并将 block 与 node 绑定，当 node 中没有可用的 ip 时，会继续分配可用的 block 块并与节点绑定。
当没有可分配的 block 也没有可用的 ip 时，会向其他节点借用 ip。</p><p>可以通过 IPAMConfiguration 配置不允许借用：
IPAM configuration ：https://docs.tigera.io/calico/latest/reference/resources/ipamconfig</p><p><img src=https://images.cherryfloris.eu.org/ryken/2024/12/87d42ffaa568a2c4108ad9086ec16d94.png width=auto alt=image.png></p><a href=#关于-blocksize-和-ippool-的配置参考><h5 id=关于-blocksize-和-ippool-的配置参考><span class=hanchor arialabel=Anchor># </span>关于 blocksize 和 ippool 的配置参考</h5></a><blockquote><p>【注意】</p><ul><li>对于不强绑定节点的需求：可以让 calico 自动分配、进行绑定，但是绑定是随机、任意的。最终绑定效果可能与下图中展示的不同。</li><li>对于强绑定节点的需求：只能手动创建出相应的绑定资源。</li></ul></blockquote><p>blocksize 与 ippool cidr 掩码不等 - 一个 ippool + 预留</p><p><img src=https://images.cherryfloris.eu.org/ryken/2024/12/3e3174616bfa77bda1295a14a163ec25.png width=auto alt=image.png></p><p>当 cidr 为 10.38.46.0/24，blocksize 为 27 时，可以分为 8 个小块，所以图中还有 2 个 block属于预留状态，当某一个节点 ip 全部分配完没有可用的 ip 时，便会重新分配 block，因此可以通过 IPReservation 配置保留未使用的 cidr 段。</p><p>设置保留 ip 地址段 - calico 版本需大于等于 3.21</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>crd.projectcalico.org/v1 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IPReservation  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-ipreservation-1  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>reservedCIDRs</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>192.168.2.3</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=m>10.0.2.3</span><span class=l>/32  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>cafe:f00d::/123</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>blocksize 与 ippool cidr 掩码不等 - 多个 ippool</p><p><img src=https://images.cherryfloris.eu.org/ryken/2024/12/c1c62c526d62c3349313048ee4df8122.png width=auto alt=image.png></p><p>当 cidr 为 10.38.46.0/26，blocksize 为 27 时，可以分为 2 个小块，刚好可以将这两个 block 分别绑定到不同的节点上。其他的同理。</p><p>这样便不会有预留的 block 情况</p><p>ippool 与 namespace 做绑定，可以限制相应的 pod 在 node</p><p>blocksize 与 ippool cidr 掩码相等 - 多个 ippool</p><p><img src=https://images.cherryfloris.eu.org/ryken/2024/12/780c6b1a0706e3290080f8ef089dae5e.png width=auto alt=image.png></p><a href=#复杂要求复杂方案---不建议><h4 id=复杂要求复杂方案---不建议><span class=hanchor arialabel=Anchor># </span>复杂要求，复杂方案 - 不建议</h4></a><p>要求1：</p><ul><li>集群节点在同一个网段，ippool 不启用 overlay 网络</li><li>ippool 绑定节点，同时可与 namespace 绑定</li><li>业务 ippool 与平台 ippool 分开使用</li><li>允许借用 ip</li></ul><p>方案：</p><ul><li>安装集群时禁用默认 ippool</li><li>手动创建平台使用的 ippool 以及业务使用 ippool、blockaffinities、ipamblock、IPReservation 资源，并将业务的 ippool 的 nodeSelector 设置为 ’!all()‘，表示只允许指定分配，无法自动分配。</li><li>用户创建相应的 namespace 时，绑定相应的 ippool</li><li>在交换机侧设置静态路由 set protocols static route ${podcidr} nexthop ${集群节点 ip}</li></ul><p>静态路由可以设置一条，也可以设置多条并启用 ecmp，<code>${集群节点 ip}</code> 选用某一个集群节点即可。假设<code>${集群节点 ip}</code>选用 master 节点，此时的到达 podCIDR 的流量都会经由 master 节点做转发。
静态路由也可以根据 block 绑定关系保持一致，总归流量到达集群内便可以在集群内相互转发了。</p><blockquote><ul><li>在安装集群时禁用了默认 ippool，避免配置的 podCIDR 初始化为一个 ippool 使得其使用率不高，禁用之后，用户可以根据自己的实际规划来创建合适大小的 ippool 用于平台 pod 和 业务 pod。</li><li>blockaffinities 是 calico 分配 ip 时根据 ippool 的 blocksize 自动分配给所需要的节点。</li><li>ipamblock 是 calico ipam 的一些分配信息。</li></ul></blockquote><p>示例 yaml：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>crd.projectcalico.org/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IPPool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ippool1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>blockSize</span><span class=p>:</span><span class=w> </span><span class=m>27</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.38.46.0</span><span class=l>/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipipMode</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>natOutgoing</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w> </span><span class=l>all()</span><span class=w> </span><span class=c># 节点选择器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vxlanMode</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>crd.projectcalico.org/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>BlockAffinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node1-10-38-46-0-27</span><span class=w> </span><span class=c># [需根据实际环境进行替换] node1 为绑定的节点名，后面为细化的 block 段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.38.46.0</span><span class=l>/27</span><span class=w> </span><span class=c>#  [需根据实际环境进行替换] 细分的 block 段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>deleted</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>node</span><span class=p>:</span><span class=w> </span><span class=l>node1</span><span class=w> </span><span class=c>#  [需根据实际环境进行替换] 绑定的节点名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>confirmed</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>crd.projectcalico.org/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IPAMBlock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=m>10-233-64-4-30</span><span class=w> </span><span class=c>#  [需根据实际环境进行替换] 细分的 block 段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w> </span><span class=l>host:staticroute-worker</span><span class=w> </span><span class=c>#  [需根据实际环境进行替换] host:绑定的节点名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>attributes</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.233.64.4</span><span class=l>/30</span><span class=w> </span><span class=c>#  [需根据实际环境进行替换] 细分的 block 段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>deleted</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allocations</span><span class=p>:</span><span class=w>  </span><span class=c>#  [需根据实际环境进行替换] 已分配的记录，需要填充为该网段所包含 ip 的大小，初始化默认为 null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>unallocated</span><span class=p>:</span><span class=w> </span><span class=c>#  [需根据实际环境进行替换] 未分配的记录，需要填充为该网段所包含 ip 的大小，填充为相应的数字</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=m>3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>缺点：</p><ul><li>扩展性受限，当有新的 ippool 需要扩容时，需要手动去创建相关资源</li><li>手动创建 calico ipam 相关资源，可能因为配置失误导致问题</li></ul><p>要求2：</p><ul><li>集群节点在同一个网段，ippool 不启用 overlay 网络</li><li>ippool 绑定节点，同时可与 namespace 绑定</li><li>业务 ippool 与平台 ippool 分开使用</li><li>不允许借用 ip</li></ul><p>方案：</p><ul><li>同上</li><li>额外配置 ipamconfiguration，不允许借用 ip</li></ul><p>缺点：</p><ul><li>当 pod 使用固定 ip 时，只能固定调度到某一个节点上</li><li>ippool 与节点绑定同时与 namespace 绑定，表示某一个 namespace 下的 pod 只能调度到ippool 绑定的节点上</li><li>扩展性受限、维护成本高</li></ul><p>静态路由可以设置一条，也可以设置多条并启用 ecmp，<code>${集群节点 ip}</code> 选用某一个集群节点即可。假设<code>${集群节点 ip}</code>选用 master 节点，此时的到达 podCIDR 的流量都会经由 master 节点做转发。
静态路由也可以根据 block 绑定关系保持一致，总归流量到达集群内便可以在集群内相互转发了。</p><p>要求3：</p><ul><li>ippool 需要启用 overlay 网络(集群节点不在同一个网段或者有其他约束)</li></ul><p>方案：</p><ul><li>暂不支持</li></ul><p><strong>客户的网络团队不愿意配合修改交换机的例子：</strong>
光大之前交付的 calico bgp tor 模式，不知什么原因疏忽了一个配置项，客户的交换机配置了 ibgp，但是没有配置 rr；之后客户与网络团队再次进行沟通时，网络团队不太愿意配合修改，因此现在光大的交付环境中的 calico 需要配置 blocksize 为 32，才不会导致发生借用 ip 时，由于黑洞路由导致无法访问的情况。</p><a href=#静态路由方案的实现><h4 id=静态路由方案的实现><span class=hanchor arialabel=Anchor># </span>静态路由方案的实现</h4></a><ol><li>设置静态路由 set protocols static route ${podcidr} nexthop ${集群节点 ip}<ul><li>podcidr 为业务 ippool 的 cidr，需要可路由的 cidr</li><li>开启 ecmp，下一跳为集群的所有节点</li></ul></li><li>集群内配置</li></ol><ul><li>将 default-ipv4-ippool nodeSelector 设置为 !all()，让其只能指定分配，不能用于自动分配；</li><li>kse 的组件/插件在安装时，所使用的 namespace 必须指定 default-ipv4-ippool 的annotation 绑定关系(安装完集群之后的插件安装，也是同理)</li><li><del>新建整大段的 calico ippool (如果是 fullmesh 的话，ippool 可以为 bgp(不跨域)，也可以为 overlay)，natoutgoing 设置为 true(false 会影响上外网，可能不是所有的交换机都配置静态路由 or nat 出网)</del></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>反向链接</h3><ul class=backlinks><li>未发现反向链接</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>内部链接关系图</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.ryken.cloud/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><hr><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><script src=alittlejs/md5.min.js></script><div id=gitalk-container></div><script>var gitalk=new Gitalk({clientID:"d21f4afcd185c95004e0",clientSecret:"8f1f442abf93a76461783af21c544717da9fc7b3",repo:"obsidian-publish",owner:"renyunkang",admin:["renyunkang"],id:location.href,distractionFreeMode:!1});gitalk.render("gitalk-container")</script><center><script>var caution=!1,now,visits;function setCookie(e,t,n,s,o,a){var i=e+"="+escape(t)+(n?"; expires="+n.toGMTString():"")+(s?"; path="+s:"")+(o?"; domain="+o:"")+(a?"; secure":"");!caution||(e+"="+escape(t)).length<=4e3?document.cookie=i:confirm("Cookie exceeds 4KB and will be cut!")&&(document.cookie=i)}function getCookie(s){var e=s+"=",n,t=document.cookie.indexOf(e);return t==-1?null:(n=document.cookie.indexOf(";",t+e.length),n==-1&&(n=document.cookie.length),unescape(document.cookie.substring(t+e.length,n)))}function deleteCookie(e,t,n){getCookie(e)&&(document.cookie=e+"="+(t?"; path="+t:"")+(n?"; domain="+n:"")+"; expires=Thu, 01-Jan-70 00:00:01 GMT")}function fixDate(e){var n=new Date(0),t=n.getTime();t>0&&e.setTime(e.getTime()-t)}now=new Date,fixDate(now),now.setTime(now.getTime()+730*24*60*60*1e3),visits=getCookie("counter"),visits?visits=parseInt(visits)+1:visits=1,setCookie("counter",visits,now),document.write("<font size=2>👋访问量："+visits+"")</script></center></div></body></html>