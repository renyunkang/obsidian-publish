<!doctype html><html lang=en><head><script async defer data-website-id=08a754c4-6690-46d7-bb80-8ff93cfa232f src=https://umami.oldwinter.top/umami.js></script><meta charset=utf-8><meta name=description content="#network #netns
 使用 arp-proxy，并在主机上添加对应的路由联通  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  # echo 1 > /proc/sys/net/ipv4/ip_forward echo 'net."><title>Knowledge Garden</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://www.ryken.cloud//icon.png><link href=https://www.ryken.cloud/styles.b3e1e36b0403ac565c9392b3e23ef3b6.min.css rel=stylesheet><link href=https://www.ryken.cloud/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://www.ryken.cloud/js/darkmode.66c3ed4615b59e04fa897375e67b0fe2.min.js></script>
<script src=https://www.ryken.cloud/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://www.ryken.cloud/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://www.ryken.cloud/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://www.ryken.cloud/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://www.ryken.cloud/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://www.ryken.cloud/",fetchData=Promise.all([fetch("https://www.ryken.cloud/indices/linkIndex.c83b530c16d6d7da0b36ea1cd7188b9b.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://www.ryken.cloud/indices/contentIndex.a50b1ae29c379c0f2cd5cb8e1f71e869.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://www.ryken.cloud",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://www.ryken.cloud",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-11MD77L81V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-11MD77L81V",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=search placeholder=支持标题及全文搜索...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://www.ryken.cloud/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://www.ryken.cloud/>Knowledge Garden</a></h1><div class=spacer></div><div id=search-icon><p>search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>最近编辑于
Unknown</p><ul class=tags></ul><aside class=mainTOC><details><summary>目录</summary><nav id=TableOfContents><ol><li><ol><li><a href=#vxlan-模式>vxlan 模式</a></li></ol></li></ol></nav></details></aside><p>#network #netns</p><ol><li>使用 arp-proxy，并在主机上添加对应的路由联通</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;net.ipv4.ip_forward = 1&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span class=line><span class=cl>sysctl -p
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns add ns0
</span></span><span class=line><span class=cl>ip link add name veth02 <span class=nb>type</span> veth peer name port02
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev veth02 netns ns0
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip link <span class=nb>set</span> veth02 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip link <span class=nb>set</span> lo up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip addr add 10.233.92.200/24 dev veth02
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> port02 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip route add 169.254.1.1 dev  veth02 scope link 
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip route add default via 169.254.1.1 dev veth02
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=m>1</span> &gt; /proc/sys/net/ipv4/conf/port02/proxy_arp
</span></span><span class=line><span class=cl>ip route add 10.233.92.200 dev port02 scope link
</span></span><span class=line><span class=cl>ip route add 10.233.128.3 via 172.31.73.13
</span></span><span class=line><span class=cl><span class=c1># iptables -t nat -A POSTROUTING -s 10.233.128.2/32 -j MASQUERADE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns add ns0
</span></span><span class=line><span class=cl>ip link add name veth02 <span class=nb>type</span> veth peer name port02
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev veth02 netns ns0
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip link <span class=nb>set</span> veth02 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip link <span class=nb>set</span> lo up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip addr add 10.233.128.3/24 dev veth02
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> port02 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip route add 169.254.1.1 dev  veth02 scope link 
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 ip route add default via 169.254.1.1 dev veth02
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=m>1</span> &gt; /proc/sys/net/ipv4/conf/port02/proxy_arp
</span></span><span class=line><span class=cl>ip route add 10.233.128.2 via 172.31.73.12
</span></span><span class=line><span class=cl>ip route add 10.233.128.3 dev port02 scope link
</span></span><span class=line><span class=cl><span class=c1># iptables -t nat -A POSTROUTING -s 10.233.128.3/32 -j MASQUERADE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns0 bash
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>带有网桥 - 使用网桥作为网关，需要开启 NAT 转换，但是无需开启 arp-proxy</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 工具准备</span>
</span></span><span class=line><span class=cl>apt install bridge-utils
</span></span><span class=line><span class=cl>modprobe br_netfilter
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;net.ipv4.ip_forward = 1&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span class=line><span class=cl>sysctl -p
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设备准备</span>
</span></span><span class=line><span class=cl>brctl addbr bridge0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns add ns10
</span></span><span class=line><span class=cl>ip link add name veth10 <span class=nb>type</span> veth peer name port10
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev veth10 netns ns10
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns10 ip addr add 172.18.0.2/24 dev veth10
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns10 ip link <span class=nb>set</span> lo up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns10 ip link <span class=nb>set</span> veth10 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns10 ip route add default via 172.18.0.1 dev veth10
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>brctl addif bridge0 port10
</span></span><span class=line><span class=cl>ip addr add 172.18.0.1/24 dev bridge0
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> bridge0 up
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev port10 up
</span></span><span class=line><span class=cl>ip route add 172.18.10.0/24 via 172.30.10.3
</span></span><span class=line><span class=cl>iptables -t nat -A POSTROUTING -s 172.18.0.0/24 ! -o bridge0 -j <span class=nv>MASQUERADE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>===</span>
</span></span><span class=line><span class=cl>brctl addbr bridge0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns add ns10
</span></span><span class=line><span class=cl>ip link add name veth10 <span class=nb>type</span> veth peer name port10
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev veth10 netns ns10
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns10 ip addr add 172.18.10.2/24 dev veth10
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns10 ip link <span class=nb>set</span> lo up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns10 ip link <span class=nb>set</span> veth10 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> ns10 ip route add default via 172.18.10.1 dev veth10
</span></span><span class=line><span class=cl>brctl addif bridge0 port10
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip addr add 172.18.10.1/24 dev bridge0
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> bridge0 up
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev port10 up
</span></span><span class=line><span class=cl>ip route add 172.18.0.0/24 via 172.30.10.2
</span></span><span class=line><span class=cl>iptables -t nat -A POSTROUTING -s 172.18.10.0/24 ! -o bridge0 -j MASQUERADE
</span></span></code></pre></td></tr></table></div></div><p>遇到的问题以及解决方法：</p><ul><li>直接使用以上命令发现不通，network namespace 无法与外界通信，只能与本机通信</li><li>安装 docker 之后仍然不行，使用 kk 安装集群之后可行，并且卸载集群之后仍然可行</li></ul><p>结论：kk 在安装时修改了部分系统参数，其实就是启用了 br_netfilter，并开启了 ipv4 的转发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 没有启用  br_netfilter 的报错</span>
</span></span><span class=line><span class=cl>sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解决方法</span>
</span></span><span class=line><span class=cl>modprobe br_netfilter  <span class=c1># 自动处理可载入模块</span>
</span></span><span class=line><span class=cl>sysctl -p /etc/sysctl.conf#
</span></span><span class=line><span class=cl>sudo bash -c <span class=s1>&#39;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 其他相关 - 移除模块</span>
</span></span><span class=line><span class=cl>modprobe -r 模块名
</span></span></code></pre></td></tr></table></div></div><a href=#vxlan-模式><h3 id=vxlan-模式><span class=hanchor arialabel=Anchor># </span>vxlan 模式</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ip netns add docker1
</span></span><span class=line><span class=cl>ip link add veth0 type veth peer name veth1
</span></span><span class=line><span class=cl>ip link set veth0 netns docker1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>brctl addbr br0
</span></span><span class=line><span class=cl>brctl addif br0 veth1
</span></span><span class=line><span class=cl>ip netns exec docker1 ip addr add 172.18.0.2/24 dev veth0
</span></span><span class=line><span class=cl>ip netns exec docker1 ip route add default via 172.18.0.1 dev veth0
</span></span><span class=line><span class=cl>ip netns exec docker1 ip link set veth0 up
</span></span><span class=line><span class=cl>ip link set veth1 up
</span></span><span class=line><span class=cl>ip addr add 172.18.0.1/24 dev br0
</span></span><span class=line><span class=cl>ip link set br0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link add vxlan0 type vxlan \
</span></span><span class=line><span class=cl>    id 42 \
</span></span><span class=line><span class=cl>    dstport 4789 \
</span></span><span class=line><span class=cl>    local 172.30.10.3 \
</span></span><span class=line><span class=cl>    dev eth0 \
</span></span><span class=line><span class=cl>    nolearning
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip addr add 172.18.0.0/24 dev vxlan0
</span></span><span class=line><span class=cl>ip link set vxlan0 up
</span></span><span class=line><span class=cl>ip route add 172.18.0.0/24 dev vxlan0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip neighbor add 10.244.2.3 lladdr 2e:0e:84:db:30:0e dev vxlan0 bridge fdb append 2e:0e:84:db:30:0e dev vxlan0 dst 172.19.216.118
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ip link add vxlan0 type vxlan \
</span></span><span class=line><span class=cl>    id 42 \
</span></span><span class=line><span class=cl>    dstport 4789 \
</span></span><span class=line><span class=cl>    remote 172.30.10.4 \
</span></span><span class=line><span class=cl>    local 172.30.10.2 \
</span></span><span class=line><span class=cl>    dev eth0 \
</span></span><span class=line><span class=cl>    nolearning
</span></span><span class=line><span class=cl>ip addr add 10.20.1.2/24 dev vxlan0
</span></span><span class=line><span class=cl>ip link set vxlan0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link add vxlan0 type vxlan \
</span></span><span class=line><span class=cl>    id 42 \
</span></span><span class=line><span class=cl>    dstport 4789 \
</span></span><span class=line><span class=cl>    remote 172.30.10.2 \
</span></span><span class=line><span class=cl>    local 172.30.10.4 \
</span></span><span class=line><span class=cl>    dev eth0 \
</span></span><span class=line><span class=cl>    nolearning
</span></span><span class=line><span class=cl>ip addr add 10.20.1.3/24 dev vxlan0
</span></span><span class=line><span class=cl>ip link set vxlan0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link add vxlan0 type vxlan \
</span></span><span class=line><span class=cl>    id 42 \
</span></span><span class=line><span class=cl>    dstport 4789 \
</span></span><span class=line><span class=cl>    remote 15.58.3.30 \
</span></span><span class=line><span class=cl>    local 15.58.3.26 \
</span></span><span class=line><span class=cl>    dev vlan135p0 \
</span></span><span class=line><span class=cl>    nolearning
</span></span><span class=line><span class=cl>ip addr add 172.18.10.2/24 dev vxlan0
</span></span><span class=line><span class=cl>ip link set vxlan0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link add vxlan0 type vxlan \
</span></span><span class=line><span class=cl>    id 42 \
</span></span><span class=line><span class=cl>    dstport 4789 \
</span></span><span class=line><span class=cl>    remote 15.58.3.26 \
</span></span><span class=line><span class=cl>    local 15.58.3.30 \
</span></span><span class=line><span class=cl>    dev vlan135p0 \
</span></span><span class=line><span class=cl>    nolearning
</span></span><span class=line><span class=cl>ip addr add 172.18.10.3/24 dev vxlan0
</span></span><span class=line><span class=cl>ip link set vxlan0 up
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ip link add vxlan0 type vxlan \
</span></span><span class=line><span class=cl>    id 42 \
</span></span><span class=line><span class=cl>    dstport 4789 \
</span></span><span class=line><span class=cl>    group 239.1.1.1 \
</span></span><span class=line><span class=cl>    local 172.30.10.3 \
</span></span><span class=line><span class=cl>    dev eth0 
</span></span><span class=line><span class=cl>ip addr add 10.128.1.0/24 dev vxlan0
</span></span><span class=line><span class=cl>ip link set vxlan0 up
</span></span><span class=line><span class=cl>ip route add 10.128.1.0/24 dev vxlan0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link add br0 type bridge
</span></span><span class=line><span class=cl>ip link set vxlan0 master br0
</span></span><span class=line><span class=cl>ip addr add 10.128.1.1/24 dev br0
</span></span><span class=line><span class=cl>ip link set br0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns add container1
</span></span><span class=line><span class=cl>ip link add veth0 type veth peer name veth1
</span></span><span class=line><span class=cl>ip link set dev veth0 master br0
</span></span><span class=line><span class=cl>ip link set dev veth0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link set dev veth1 netns container1
</span></span><span class=line><span class=cl>ip netns exec container1 ip link set lo up
</span></span><span class=line><span class=cl>ip netns exec container1 ip link set veth1 name eth0
</span></span><span class=line><span class=cl>ip netns exec container1 ip link set eth0 up
</span></span><span class=line><span class=cl>ip netns exec container1 ip addr add 10.128.1.2/24 dev eth0
</span></span><span class=line><span class=cl>ip netns exec container1 ip route add default via 10.128.1.1 dev eth0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link add vxlan0 type vxlan \
</span></span><span class=line><span class=cl>    id 42 \
</span></span><span class=line><span class=cl>    dstport 4789 \
</span></span><span class=line><span class=cl>    group 239.1.1.1 \
</span></span><span class=line><span class=cl>    local 172.30.10.5 \
</span></span><span class=line><span class=cl>    dev eth0 
</span></span><span class=line><span class=cl>ip link set vxlan0 up
</span></span><span class=line><span class=cl>ip addr add 10.128.2.0/24 dev vxlan0
</span></span><span class=line><span class=cl>ip route add 10.128.2.0/24 dev vxlan0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link add br0 type bridge
</span></span><span class=line><span class=cl>ip link set vxlan0 master br0
</span></span><span class=line><span class=cl>ip addr add 10.128.2.1/24 dev br0
</span></span><span class=line><span class=cl>ip link set br0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns add container1
</span></span><span class=line><span class=cl>ip link add veth0 type veth peer name veth1
</span></span><span class=line><span class=cl>ip link set dev veth0 master br0
</span></span><span class=line><span class=cl>ip link set dev veth0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link set dev veth1 netns container1
</span></span><span class=line><span class=cl>ip netns exec container1 ip link set lo up
</span></span><span class=line><span class=cl>ip netns exec container1 ip link set veth1 name eth0
</span></span><span class=line><span class=cl>ip netns exec container1 ip link set eth0 up
</span></span><span class=line><span class=cl>ip netns exec container1 ip addr add 10.128.2.2/24 dev eth0
</span></span><span class=line><span class=cl>ip netns exec container1 ip route add default via 10.128.2.1 dev eth0
</span></span></code></pre></td></tr></table></div></div><hr><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ip link add br0 type bridge $ ip link set vxlan0 master br0 $ ip link add vrf0 type vrf table 10 $ ip link set br0 master vrf0 $ ip link set vxlan0 up $ ip link set br0 up $ ip link set vrf0 up
</span></span></code></pre></td></tr></table></div></div><p>ip netns add ns0
ip link add name veth02 type veth peer name port02
ip link set dev veth02 netns ns0
ip netns exec ns0 ip link set veth02 up
ip netns exec ns0 ip link set lo up
ip netns exec ns0 ip addr add 10.233.128.2/24 dev veth02
ip link set port02 up
ip netns exec ns0 ip route add 169.254.1.1 dev veth02 scope link
ip netns exec ns0 ip route add default via 169.254.1.1 dev veth02
echo 1 > /proc/sys/net/ipv4/conf/port02/proxy_arp
ip route add 10.233.128.3 via 172.31.50.25
ip route add 10.233.128.2 dev port02 scope link</p><p>ip netns add ns0
ip link add name veth02 type veth peer name port02
ip link set dev veth02 netns ns0
ip netns exec ns0 ip link set veth02 up
ip netns exec ns0 ip link set lo up
ip netns exec ns0 ip addr add 10.233.128.3/24 dev veth02
ip link set port02 up
ip netns exec ns0 ip route add 169.254.1.1 dev veth02 scope link
ip netns exec ns0 ip route add default via 169.254.1.1 dev veth02
echo 1 > /proc/sys/net/ipv4/conf/port02/proxy_arp
ip route add 10.233.128.2 via 172.31.50.24
ip route add 10.233.128.3 dev port02 scope link</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>反向链接</h3><ul class=backlinks><li><a href=/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0-hybridnet-%E5%AE%9E%E8%B7%B5/ data-ctx="手动创建 netns + 跨主机通信" data-src=/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0-hybridnet-%E5%AE%9E%E8%B7%B5 class=internal-link>动手实现 hybridnet - 实践</a></li><li><a href=/cni-network/ data-ctx="手动创建 netns + 跨主机通信" data-src=/cni-network class=internal-link></a></li><li><a href=/perf-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/ data-ctx="手动创建 netns + 跨主机通信" data-src=/perf-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90 class=internal-link>perf 性能分析</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>内部链接关系图</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://www.ryken.cloud/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><hr><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><script src=alittlejs/md5.min.js></script><div id=gitalk-container></div><script>var gitalk=new Gitalk({clientID:"d21f4afcd185c95004e0",clientSecret:"8f1f442abf93a76461783af21c544717da9fc7b3",repo:"obsidian-publish",owner:"renyunkang",admin:["renyunkang"],id:location.href,distractionFreeMode:!1});gitalk.render("gitalk-container")</script><center><script>var caution=!1,now,visits;function setCookie(e,t,n,s,o,a){var i=e+"="+escape(t)+(n?"; expires="+n.toGMTString():"")+(s?"; path="+s:"")+(o?"; domain="+o:"")+(a?"; secure":"");!caution||(e+"="+escape(t)).length<=4e3?document.cookie=i:confirm("Cookie exceeds 4KB and will be cut!")&&(document.cookie=i)}function getCookie(s){var e=s+"=",n,t=document.cookie.indexOf(e);return t==-1?null:(n=document.cookie.indexOf(";",t+e.length),n==-1&&(n=document.cookie.length),unescape(document.cookie.substring(t+e.length,n)))}function deleteCookie(e,t,n){getCookie(e)&&(document.cookie=e+"="+(t?"; path="+t:"")+(n?"; domain="+n:"")+"; expires=Thu, 01-Jan-70 00:00:01 GMT")}function fixDate(e){var n=new Date(0),t=n.getTime();t>0&&e.setTime(e.getTime()-t)}now=new Date,fixDate(now),now.setTime(now.getTime()+730*24*60*60*1e3),visits=getCookie("counter"),visits?visits=parseInt(visits)+1:visits=1,setCookie("counter",visits,now),document.write("<font size=2>👋访问量："+visits+"")</script></center></div></body></html>